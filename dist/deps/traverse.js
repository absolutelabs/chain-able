/* eslint no-new-wrappers: "off" */
/* eslint eqeqeq: "off" */
/* eslint func-style: "off" */
var isPureObj = require('./is/pureObj')
var isRegExp = require('./is/regexp')
var isError = require('./is/error')
var isBoolean = require('./is/boolean')
var isNumber = require('./is/number')
var isString = require('./is/string')
var isDate = require('./is/date')
// was inline for size?
var isArray = require('./is/array')
var hasOwnProperty = require('./util/hasOwnProperty')
var objectKeys = require('./util/keys')
var argumentor = require('./argumentor')

/**
 * @param {Array | Object | any} xs
 * @param {Function} fn
 * @TODO: unexpectedly breaks things iterating
 * if you are relying on internal functionality
 * (such as .path, .get, .value...) with map & set
 *
 * @desc if there is .forEach on the obj already, use it
 * otherwise, call function for each
 */
var forEach = function(xs, fn) {
  if (xs.forEach) { xs.forEach(fn) }
  else { for (var i = 0; i < xs.length; i++) { fn(xs[i], i, xs) } }
}

var traverse = function(obj) {
  return new Traverse(obj)
}
module.exports = traverse

/**
 * @TODO: symbol, map, set
 * @tutorial https://github.com/substack/js-traverse
 * @classdesc Traverse.js
 * @param {Travcersable} obj
 * @constructor
 */
function Traverse(obj) {
  this.value = obj
}

/**
 * @see this.forEach
 * @todo hasOwnProperty
 * @param  {Array<string>} ps paths
 * @return {any} value at dot-prop
 */
Traverse.prototype.get = function(ps) {
  var node = this.value
  for (var i = 0; i < ps.length; i++) {
    var key = ps[i]
    if (!node || !hasOwnProperty(node, key)) {
      node = undefined
      break
    }
    node = node[key]
  }
  return node
}

/**
 * @see hasOwnProperty
 * @param  {Array<string>} ps paths
 * @return {boolean}
 */
Traverse.prototype.has = function(ps) {
  var node = this.value
  for (var i = 0; i < ps.length; i++) {
    var key = ps[i]
    if (!node || !hasOwnProperty(node, key)) {
      return false
    }
    node = node[key]
  }
  return true
}

Traverse.prototype.set = function(ps, value) {
  var node = this.value
  var i = 0
  for (; i < ps.length - 1; i++) {
    var key = ps[i]
    if (!hasOwnProperty(node, key)) { node[key] = {} }
    node = node[key]
  }
  node[ps[i]] = value
  return value
}

/**
 * @see walk
 * @param  {Function} cb
 * @return {any}
 */
Traverse.prototype.map = function(cb) {
  return walk(this.value, cb, true)
}

/**
 * @param  {Function} cb
 * @return {any} this.value
 */
Traverse.prototype.forEach = function(cb) {
  this.value = walk(this.value, cb, false)
  return this.value
}

/**
 * @since 4.0.0
 * @param  {Function} cb
 * @return {any} this.value
 */
Traverse.prototype.forEachs = function(cb) {
  return this.forEach(function(x) {
    cb.call(this, this, x)
  })
}

Traverse.prototype.reduce = function(cb, init) {
  var skip = arguments.length === 1
  var acc = skip ? this.value : init
  this.forEach(function(x) {
    if (!this.isRoot || !skip) {
      acc = cb.call(this, acc, x)
    }
  })
  return acc
}

Traverse.prototype.paths = function() {
  var acc = []
  this.forEach(function(x) {
    acc.push(this.path)
  })
  return acc
}

Traverse.prototype.nodes = function() {
  var acc = []
  this.forEach(function(x) {
    acc.push(this.node)
  })
  return acc
}

Traverse.prototype.clone = function() {
  var parents = []
  var nodes = []

  return (function clone(src) {
    for (var i = 0; i < parents.length; i++) {
      if (parents[i] === src) {
        return nodes[i]
      }
    }

    if (isPureObj(src)) {
      var dst = copy(src)

      parents.push(src)
      nodes.push(dst)

      forEach(objectKeys(src), function (key) {
        dst[key] = clone(src[key])
      })

      parents.pop()
      nodes.pop()
      return dst
    }
    else {
      return src
    }
  })(this.value)
}

function walk(root, cb, immutable) {
  var path = []
  var parents = []
  var alive = true

  return (function walker(node_) {
    // both are objs with properties that get changed but
    var node = immutable ? copy(node_) : node_
    var modifiers = {}
    var keepGoing = true

    var state = {
      node: node,
      node_: node_,
      path: [].concat(path),
      parent: parents[parents.length - 1],
      parents: parents,
      key: path.slice(-1)[0],
      isRoot: path.length === 0,
      level: path.length,
      circular: null,
      update: function update(x, stopHere) {
        if (!state.isRoot) {
          state.parent.node[state.key] = x
        }
        state.node = x
        if (stopHere) { keepGoing = false }
      },
      delete: function delete$1(stopHere) {
        delete state.parent.node[state.key]
        if (stopHere) { keepGoing = false }
      },
      remove: function remove(stopHere) {
        // @NOTE safety
        if (state.parent === undefined) {
          return
        }
        else if (isArray(state.parent.node)) {
          state.parent.node.splice(state.key, 1)
        }
        else {
          delete state.parent.node[state.key]
        }
        if (stopHere) { keepGoing = false }
      },
      keys: null,
      before: function before(f) {
        modifiers.before = f
      },
      after: function after(f) {
        modifiers.after = f
      },
      pre: function pre(f) {
        modifiers.pre = f
      },
      post: function post(f) {
        modifiers.post = f
      },
      stop: function stop() {
        alive = false
      },
      block: function block() {
        keepGoing = false
      },
    }

    if (!alive) { return state }

    function updateState() {
      if (isPureObj(state.node)) {
        if (!state.keys || state.node_ !== state.node) {
          state.keys = objectKeys(state.node)
        }

        state.isLeaf = state.keys.length == 0

        for (var i = 0; i < parents.length; i++) {
          if (parents[i].node_ === node_) {
            state.circular = parents[i]
            break
          }
        }
      }
      else {
        state.isLeaf = true
        state.keys = null
      }

      state.notLeaf = !state.isLeaf
      state.notRoot = !state.isRoot
    }

    updateState()

    // @NOTE added last `,state` arg to not have it have to use `this`,
    // but broke some things so moved to another fn
    //
    // use return values to update if defined
    var ret = cb.call(state, state.node)
    if (ret !== undefined && state.update) { state.update(ret) }

    if (modifiers.before) { modifiers.before.call(state, state.node) }

    if (!keepGoing) { return state }

    // when it's some sort of itertable object, loop it further
    if (isPureObj(state.node) && !state.circular) {
      parents.push(state)

      updateState()

      forEach(state.keys, function (key, i) {
        path.push(key)

        if (modifiers.pre) { modifiers.pre.call(state, state.node[key], key) }

        var child = walker(state.node[key])
        if (immutable && hasOwnProperty(state.node, key)) {
          state.node[key] = child.node
        }

        child.isLast = i == state.keys.length - 1
        child.isFirst = i == 0

        if (modifiers.post) { modifiers.post.call(state, child) }

        path.pop()
      })
      parents.pop()
    }

    if (modifiers.after) { modifiers.after.call(state, state.node) }

    return state
  })(root).node
}

function copy(src) {
  // require('fliplog').data(src).bold('copying').echo()
  if (isPureObj(src)) {
    var dst

    // const reduce = require('./reduce')
    // const toarr = require('./to-arr')
    // require('fliplog').underline('is obj').echo()
    // @TODO:
    // if (isMap(src)) {
    //   require('fliplog').underline('is map').echo()
    //   dst = reduce(src.entries())
    // }
    // else if (isSet(src)) {
    //   dst = toarr(src)
    // }
    if (isArray(src)) {
      dst = []
    }
    else if (isDate(src)) {
      dst = new Date(src.getTime ? src.getTime() : src)
    }
    else if (isRegExp(src)) {
      dst = new RegExp(src)
    }
    else if (isError(src)) {
      dst = {message: src.message}
    }
    else if (isBoolean(src)) {
      dst = new Boolean(src)
    }
    else if (isNumber(src)) {
      dst = new Number(src)
    }
    else if (isString(src)) {
      dst = new String(src)
    }
    else {
      //if (Object.create && Object.getPrototypeOf)
      dst = Object.create(Object.getPrototypeOf(src))
    }
    // else if (src.constructor === Object) {
    //   dst = {}
    // }
    // else {
    //   // @NOTE: only happens if above getPrototypeOf does not exist
    //   var proto = (src.constructor && src.constructor.prototype) ||
    //   src.__proto__ || {}
    //   var T = function() {}
    //   T.prototype = proto
    //   dst = new T()
    // }

    forEach(objectKeys(src), function (key) {
      dst[key] = src[key]
    })
    return dst
  }
  else {
    // require('fliplog').red('is NOT OBJ').echo()
    return src
  }
}

forEach(objectKeys(Traverse.prototype), function (key) {
  traverse[key] = function(obj) {
    // var args = [].slice.call(arguments, 1)
    var args = argumentor.apply(null, arguments).slice(1)

    var t = new Traverse(obj)
    return t[key].apply(t, args)
  }
})

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhdmVyc2UuanMiLCJzb3VyY2VzIjpbInRyYXZlcnNlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCBuby1uZXctd3JhcHBlcnM6IFwib2ZmXCIgKi9cbi8qIGVzbGludCBlcWVxZXE6IFwib2ZmXCIgKi9cbi8qIGVzbGludCBmdW5jLXN0eWxlOiBcIm9mZlwiICovXG5jb25zdCBpc1B1cmVPYmogPSByZXF1aXJlKCcuL2lzL3B1cmVPYmonKVxuY29uc3QgaXNSZWdFeHAgPSByZXF1aXJlKCcuL2lzL3JlZ2V4cCcpXG5jb25zdCBpc0Vycm9yID0gcmVxdWlyZSgnLi9pcy9lcnJvcicpXG5jb25zdCBpc0Jvb2xlYW4gPSByZXF1aXJlKCcuL2lzL2Jvb2xlYW4nKVxuY29uc3QgaXNOdW1iZXIgPSByZXF1aXJlKCcuL2lzL251bWJlcicpXG5jb25zdCBpc1N0cmluZyA9IHJlcXVpcmUoJy4vaXMvc3RyaW5nJylcbmNvbnN0IGlzRGF0ZSA9IHJlcXVpcmUoJy4vaXMvZGF0ZScpXG4vLyB3YXMgaW5saW5lIGZvciBzaXplP1xuY29uc3QgaXNBcnJheSA9IHJlcXVpcmUoJy4vaXMvYXJyYXknKVxuY29uc3QgaGFzT3duUHJvcGVydHkgPSByZXF1aXJlKCcuL3V0aWwvaGFzT3duUHJvcGVydHknKVxuY29uc3Qgb2JqZWN0S2V5cyA9IHJlcXVpcmUoJy4vdXRpbC9rZXlzJylcbmNvbnN0IGFyZ3VtZW50b3IgPSByZXF1aXJlKCcuL2FyZ3VtZW50b3InKVxuXG4vKipcbiAqIEBwYXJhbSB7QXJyYXkgfCBPYmplY3QgfCBhbnl9IHhzXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSBmblxuICogQFRPRE86IHVuZXhwZWN0ZWRseSBicmVha3MgdGhpbmdzIGl0ZXJhdGluZ1xuICogaWYgeW91IGFyZSByZWx5aW5nIG9uIGludGVybmFsIGZ1bmN0aW9uYWxpdHlcbiAqIChzdWNoIGFzIC5wYXRoLCAuZ2V0LCAudmFsdWUuLi4pIHdpdGggbWFwICYgc2V0XG4gKlxuICogQGRlc2MgaWYgdGhlcmUgaXMgLmZvckVhY2ggb24gdGhlIG9iaiBhbHJlYWR5LCB1c2UgaXRcbiAqIG90aGVyd2lzZSwgY2FsbCBmdW5jdGlvbiBmb3IgZWFjaFxuICovXG52YXIgZm9yRWFjaCA9IGZ1bmN0aW9uKHhzLCBmbikge1xuICBpZiAoeHMuZm9yRWFjaCkgeHMuZm9yRWFjaChmbilcbiAgZWxzZSBmb3IgKGxldCBpID0gMDsgaSA8IHhzLmxlbmd0aDsgaSsrKSBmbih4c1tpXSwgaSwgeHMpXG59XG5cbnZhciB0cmF2ZXJzZSA9IGZ1bmN0aW9uKG9iaikge1xuICByZXR1cm4gbmV3IFRyYXZlcnNlKG9iailcbn1cbm1vZHVsZS5leHBvcnRzID0gdHJhdmVyc2VcblxuLyoqXG4gKiBAVE9ETzogc3ltYm9sLCBtYXAsIHNldFxuICogQHR1dG9yaWFsIGh0dHBzOi8vZ2l0aHViLmNvbS9zdWJzdGFjay9qcy10cmF2ZXJzZVxuICogQGNsYXNzZGVzYyBUcmF2ZXJzZS5qc1xuICogQHBhcmFtIHtUcmF2Y2Vyc2FibGV9IG9ialxuICogQGNvbnN0cnVjdG9yXG4gKi9cbmZ1bmN0aW9uIFRyYXZlcnNlKG9iaikge1xuICB0aGlzLnZhbHVlID0gb2JqXG59XG5cbi8qKlxuICogQHNlZSB0aGlzLmZvckVhY2hcbiAqIEB0b2RvIGhhc093blByb3BlcnR5XG4gKiBAcGFyYW0gIHtBcnJheTxzdHJpbmc+fSBwcyBwYXRoc1xuICogQHJldHVybiB7YW55fSB2YWx1ZSBhdCBkb3QtcHJvcFxuICovXG5UcmF2ZXJzZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24ocHMpIHtcbiAgbGV0IG5vZGUgPSB0aGlzLnZhbHVlXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcHMubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBrZXkgPSBwc1tpXVxuICAgIGlmICghbm9kZSB8fCAhaGFzT3duUHJvcGVydHkobm9kZSwga2V5KSkge1xuICAgICAgbm9kZSA9IHVuZGVmaW5lZFxuICAgICAgYnJlYWtcbiAgICB9XG4gICAgbm9kZSA9IG5vZGVba2V5XVxuICB9XG4gIHJldHVybiBub2RlXG59XG5cbi8qKlxuICogQHNlZSBoYXNPd25Qcm9wZXJ0eVxuICogQHBhcmFtICB7QXJyYXk8c3RyaW5nPn0gcHMgcGF0aHNcbiAqIEByZXR1cm4ge2Jvb2xlYW59XG4gKi9cblRyYXZlcnNlLnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbihwcykge1xuICBsZXQgbm9kZSA9IHRoaXMudmFsdWVcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGtleSA9IHBzW2ldXG4gICAgaWYgKCFub2RlIHx8ICFoYXNPd25Qcm9wZXJ0eShub2RlLCBrZXkpKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgbm9kZSA9IG5vZGVba2V5XVxuICB9XG4gIHJldHVybiB0cnVlXG59XG5cblRyYXZlcnNlLnByb3RvdHlwZS5zZXQgPSBmdW5jdGlvbihwcywgdmFsdWUpIHtcbiAgbGV0IG5vZGUgPSB0aGlzLnZhbHVlXG4gIGxldCBpID0gMFxuICBmb3IgKDsgaSA8IHBzLmxlbmd0aCAtIDE7IGkrKykge1xuICAgIGNvbnN0IGtleSA9IHBzW2ldXG4gICAgaWYgKCFoYXNPd25Qcm9wZXJ0eShub2RlLCBrZXkpKSBub2RlW2tleV0gPSB7fVxuICAgIG5vZGUgPSBub2RlW2tleV1cbiAgfVxuICBub2RlW3BzW2ldXSA9IHZhbHVlXG4gIHJldHVybiB2YWx1ZVxufVxuXG4vKipcbiAqIEBzZWUgd2Fsa1xuICogQHBhcmFtICB7RnVuY3Rpb259IGNiXG4gKiBAcmV0dXJuIHthbnl9XG4gKi9cblRyYXZlcnNlLnByb3RvdHlwZS5tYXAgPSBmdW5jdGlvbihjYikge1xuICByZXR1cm4gd2Fsayh0aGlzLnZhbHVlLCBjYiwgdHJ1ZSlcbn1cblxuLyoqXG4gKiBAcGFyYW0gIHtGdW5jdGlvbn0gY2JcbiAqIEByZXR1cm4ge2FueX0gdGhpcy52YWx1ZVxuICovXG5UcmF2ZXJzZS5wcm90b3R5cGUuZm9yRWFjaCA9IGZ1bmN0aW9uKGNiKSB7XG4gIHRoaXMudmFsdWUgPSB3YWxrKHRoaXMudmFsdWUsIGNiLCBmYWxzZSlcbiAgcmV0dXJuIHRoaXMudmFsdWVcbn1cblxuLyoqXG4gKiBAc2luY2UgNC4wLjBcbiAqIEBwYXJhbSAge0Z1bmN0aW9ufSBjYlxuICogQHJldHVybiB7YW55fSB0aGlzLnZhbHVlXG4gKi9cblRyYXZlcnNlLnByb3RvdHlwZS5mb3JFYWNocyA9IGZ1bmN0aW9uKGNiKSB7XG4gIHJldHVybiB0aGlzLmZvckVhY2goZnVuY3Rpb24oeCkge1xuICAgIGNiLmNhbGwodGhpcywgdGhpcywgeClcbiAgfSlcbn1cblxuVHJhdmVyc2UucHJvdG90eXBlLnJlZHVjZSA9IGZ1bmN0aW9uKGNiLCBpbml0KSB7XG4gIGNvbnN0IHNraXAgPSBhcmd1bWVudHMubGVuZ3RoID09PSAxXG4gIGxldCBhY2MgPSBza2lwID8gdGhpcy52YWx1ZSA6IGluaXRcbiAgdGhpcy5mb3JFYWNoKGZ1bmN0aW9uKHgpIHtcbiAgICBpZiAoIXRoaXMuaXNSb290IHx8ICFza2lwKSB7XG4gICAgICBhY2MgPSBjYi5jYWxsKHRoaXMsIGFjYywgeClcbiAgICB9XG4gIH0pXG4gIHJldHVybiBhY2Ncbn1cblxuVHJhdmVyc2UucHJvdG90eXBlLnBhdGhzID0gZnVuY3Rpb24oKSB7XG4gIGNvbnN0IGFjYyA9IFtdXG4gIHRoaXMuZm9yRWFjaChmdW5jdGlvbih4KSB7XG4gICAgYWNjLnB1c2godGhpcy5wYXRoKVxuICB9KVxuICByZXR1cm4gYWNjXG59XG5cblRyYXZlcnNlLnByb3RvdHlwZS5ub2RlcyA9IGZ1bmN0aW9uKCkge1xuICBjb25zdCBhY2MgPSBbXVxuICB0aGlzLmZvckVhY2goZnVuY3Rpb24oeCkge1xuICAgIGFjYy5wdXNoKHRoaXMubm9kZSlcbiAgfSlcbiAgcmV0dXJuIGFjY1xufVxuXG5UcmF2ZXJzZS5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbigpIHtcbiAgbGV0IHBhcmVudHMgPSBbXVxuICBsZXQgbm9kZXMgPSBbXVxuXG4gIHJldHVybiAoZnVuY3Rpb24gY2xvbmUoc3JjKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJlbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAocGFyZW50c1tpXSA9PT0gc3JjKSB7XG4gICAgICAgIHJldHVybiBub2Rlc1tpXVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChpc1B1cmVPYmooc3JjKSkge1xuICAgICAgbGV0IGRzdCA9IGNvcHkoc3JjKVxuXG4gICAgICBwYXJlbnRzLnB1c2goc3JjKVxuICAgICAgbm9kZXMucHVzaChkc3QpXG5cbiAgICAgIGZvckVhY2gob2JqZWN0S2V5cyhzcmMpLCBrZXkgPT4ge1xuICAgICAgICBkc3Rba2V5XSA9IGNsb25lKHNyY1trZXldKVxuICAgICAgfSlcblxuICAgICAgcGFyZW50cy5wb3AoKVxuICAgICAgbm9kZXMucG9wKClcbiAgICAgIHJldHVybiBkc3RcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICByZXR1cm4gc3JjXG4gICAgfVxuICB9KSh0aGlzLnZhbHVlKVxufVxuXG5mdW5jdGlvbiB3YWxrKHJvb3QsIGNiLCBpbW11dGFibGUpIHtcbiAgbGV0IHBhdGggPSBbXVxuICBsZXQgcGFyZW50cyA9IFtdXG4gIGxldCBhbGl2ZSA9IHRydWVcblxuICByZXR1cm4gKGZ1bmN0aW9uIHdhbGtlcihub2RlXykge1xuICAgIC8vIGJvdGggYXJlIG9ianMgd2l0aCBwcm9wZXJ0aWVzIHRoYXQgZ2V0IGNoYW5nZWQgYnV0XG4gICAgY29uc3Qgbm9kZSA9IGltbXV0YWJsZSA/IGNvcHkobm9kZV8pIDogbm9kZV9cbiAgICBjb25zdCBtb2RpZmllcnMgPSB7fVxuICAgIGxldCBrZWVwR29pbmcgPSB0cnVlXG5cbiAgICBjb25zdCBzdGF0ZSA9IHtcbiAgICAgIG5vZGUsXG4gICAgICBub2RlXyxcbiAgICAgIHBhdGg6IFtdLmNvbmNhdChwYXRoKSxcbiAgICAgIHBhcmVudDogcGFyZW50c1twYXJlbnRzLmxlbmd0aCAtIDFdLFxuICAgICAgcGFyZW50cyxcbiAgICAgIGtleTogcGF0aC5zbGljZSgtMSlbMF0sXG4gICAgICBpc1Jvb3Q6IHBhdGgubGVuZ3RoID09PSAwLFxuICAgICAgbGV2ZWw6IHBhdGgubGVuZ3RoLFxuICAgICAgY2lyY3VsYXI6IG51bGwsXG4gICAgICB1cGRhdGUoeCwgc3RvcEhlcmUpIHtcbiAgICAgICAgaWYgKCFzdGF0ZS5pc1Jvb3QpIHtcbiAgICAgICAgICBzdGF0ZS5wYXJlbnQubm9kZVtzdGF0ZS5rZXldID0geFxuICAgICAgICB9XG4gICAgICAgIHN0YXRlLm5vZGUgPSB4XG4gICAgICAgIGlmIChzdG9wSGVyZSkga2VlcEdvaW5nID0gZmFsc2VcbiAgICAgIH0sXG4gICAgICBkZWxldGUoc3RvcEhlcmUpIHtcbiAgICAgICAgZGVsZXRlIHN0YXRlLnBhcmVudC5ub2RlW3N0YXRlLmtleV1cbiAgICAgICAgaWYgKHN0b3BIZXJlKSBrZWVwR29pbmcgPSBmYWxzZVxuICAgICAgfSxcbiAgICAgIHJlbW92ZShzdG9wSGVyZSkge1xuICAgICAgICAvLyBATk9URSBzYWZldHlcbiAgICAgICAgaWYgKHN0YXRlLnBhcmVudCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoaXNBcnJheShzdGF0ZS5wYXJlbnQubm9kZSkpIHtcbiAgICAgICAgICBzdGF0ZS5wYXJlbnQubm9kZS5zcGxpY2Uoc3RhdGUua2V5LCAxKVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgIGRlbGV0ZSBzdGF0ZS5wYXJlbnQubm9kZVtzdGF0ZS5rZXldXG4gICAgICAgIH1cbiAgICAgICAgaWYgKHN0b3BIZXJlKSBrZWVwR29pbmcgPSBmYWxzZVxuICAgICAgfSxcbiAgICAgIGtleXM6IG51bGwsXG4gICAgICBiZWZvcmUoZikge1xuICAgICAgICBtb2RpZmllcnMuYmVmb3JlID0gZlxuICAgICAgfSxcbiAgICAgIGFmdGVyKGYpIHtcbiAgICAgICAgbW9kaWZpZXJzLmFmdGVyID0gZlxuICAgICAgfSxcbiAgICAgIHByZShmKSB7XG4gICAgICAgIG1vZGlmaWVycy5wcmUgPSBmXG4gICAgICB9LFxuICAgICAgcG9zdChmKSB7XG4gICAgICAgIG1vZGlmaWVycy5wb3N0ID0gZlxuICAgICAgfSxcbiAgICAgIHN0b3AoKSB7XG4gICAgICAgIGFsaXZlID0gZmFsc2VcbiAgICAgIH0sXG4gICAgICBibG9jaygpIHtcbiAgICAgICAga2VlcEdvaW5nID0gZmFsc2VcbiAgICAgIH0sXG4gICAgfVxuXG4gICAgaWYgKCFhbGl2ZSkgcmV0dXJuIHN0YXRlXG5cbiAgICBmdW5jdGlvbiB1cGRhdGVTdGF0ZSgpIHtcbiAgICAgIGlmIChpc1B1cmVPYmooc3RhdGUubm9kZSkpIHtcbiAgICAgICAgaWYgKCFzdGF0ZS5rZXlzIHx8IHN0YXRlLm5vZGVfICE9PSBzdGF0ZS5ub2RlKSB7XG4gICAgICAgICAgc3RhdGUua2V5cyA9IG9iamVjdEtleXMoc3RhdGUubm9kZSlcbiAgICAgICAgfVxuXG4gICAgICAgIHN0YXRlLmlzTGVhZiA9IHN0YXRlLmtleXMubGVuZ3RoID09IDBcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcmVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBpZiAocGFyZW50c1tpXS5ub2RlXyA9PT0gbm9kZV8pIHtcbiAgICAgICAgICAgIHN0YXRlLmNpcmN1bGFyID0gcGFyZW50c1tpXVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICBzdGF0ZS5pc0xlYWYgPSB0cnVlXG4gICAgICAgIHN0YXRlLmtleXMgPSBudWxsXG4gICAgICB9XG5cbiAgICAgIHN0YXRlLm5vdExlYWYgPSAhc3RhdGUuaXNMZWFmXG4gICAgICBzdGF0ZS5ub3RSb290ID0gIXN0YXRlLmlzUm9vdFxuICAgIH1cblxuICAgIHVwZGF0ZVN0YXRlKClcblxuICAgIC8vIEBOT1RFIGFkZGVkIGxhc3QgYCxzdGF0ZWAgYXJnIHRvIG5vdCBoYXZlIGl0IGhhdmUgdG8gdXNlIGB0aGlzYCxcbiAgICAvLyBidXQgYnJva2Ugc29tZSB0aGluZ3Mgc28gbW92ZWQgdG8gYW5vdGhlciBmblxuICAgIC8vXG4gICAgLy8gdXNlIHJldHVybiB2YWx1ZXMgdG8gdXBkYXRlIGlmIGRlZmluZWRcbiAgICBsZXQgcmV0ID0gY2IuY2FsbChzdGF0ZSwgc3RhdGUubm9kZSlcbiAgICBpZiAocmV0ICE9PSB1bmRlZmluZWQgJiYgc3RhdGUudXBkYXRlKSBzdGF0ZS51cGRhdGUocmV0KVxuXG4gICAgaWYgKG1vZGlmaWVycy5iZWZvcmUpIG1vZGlmaWVycy5iZWZvcmUuY2FsbChzdGF0ZSwgc3RhdGUubm9kZSlcblxuICAgIGlmICgha2VlcEdvaW5nKSByZXR1cm4gc3RhdGVcblxuICAgIC8vIHdoZW4gaXQncyBzb21lIHNvcnQgb2YgaXRlcnRhYmxlIG9iamVjdCwgbG9vcCBpdCBmdXJ0aGVyXG4gICAgaWYgKGlzUHVyZU9iaihzdGF0ZS5ub2RlKSAmJiAhc3RhdGUuY2lyY3VsYXIpIHtcbiAgICAgIHBhcmVudHMucHVzaChzdGF0ZSlcblxuICAgICAgdXBkYXRlU3RhdGUoKVxuXG4gICAgICBmb3JFYWNoKHN0YXRlLmtleXMsIChrZXksIGkpID0+IHtcbiAgICAgICAgcGF0aC5wdXNoKGtleSlcblxuICAgICAgICBpZiAobW9kaWZpZXJzLnByZSkgbW9kaWZpZXJzLnByZS5jYWxsKHN0YXRlLCBzdGF0ZS5ub2RlW2tleV0sIGtleSlcblxuICAgICAgICBjb25zdCBjaGlsZCA9IHdhbGtlcihzdGF0ZS5ub2RlW2tleV0pXG4gICAgICAgIGlmIChpbW11dGFibGUgJiYgaGFzT3duUHJvcGVydHkoc3RhdGUubm9kZSwga2V5KSkge1xuICAgICAgICAgIHN0YXRlLm5vZGVba2V5XSA9IGNoaWxkLm5vZGVcbiAgICAgICAgfVxuXG4gICAgICAgIGNoaWxkLmlzTGFzdCA9IGkgPT0gc3RhdGUua2V5cy5sZW5ndGggLSAxXG4gICAgICAgIGNoaWxkLmlzRmlyc3QgPSBpID09IDBcblxuICAgICAgICBpZiAobW9kaWZpZXJzLnBvc3QpIG1vZGlmaWVycy5wb3N0LmNhbGwoc3RhdGUsIGNoaWxkKVxuXG4gICAgICAgIHBhdGgucG9wKClcbiAgICAgIH0pXG4gICAgICBwYXJlbnRzLnBvcCgpXG4gICAgfVxuXG4gICAgaWYgKG1vZGlmaWVycy5hZnRlcikgbW9kaWZpZXJzLmFmdGVyLmNhbGwoc3RhdGUsIHN0YXRlLm5vZGUpXG5cbiAgICByZXR1cm4gc3RhdGVcbiAgfSkocm9vdCkubm9kZVxufVxuXG5mdW5jdGlvbiBjb3B5KHNyYykge1xuICAvLyByZXF1aXJlKCdmbGlwbG9nJykuZGF0YShzcmMpLmJvbGQoJ2NvcHlpbmcnKS5lY2hvKClcbiAgaWYgKGlzUHVyZU9iaihzcmMpKSB7XG4gICAgbGV0IGRzdFxuXG4gICAgLy8gY29uc3QgcmVkdWNlID0gcmVxdWlyZSgnLi9yZWR1Y2UnKVxuICAgIC8vIGNvbnN0IHRvYXJyID0gcmVxdWlyZSgnLi90by1hcnInKVxuICAgIC8vIHJlcXVpcmUoJ2ZsaXBsb2cnKS51bmRlcmxpbmUoJ2lzIG9iaicpLmVjaG8oKVxuICAgIC8vIEBUT0RPOlxuICAgIC8vIGlmIChpc01hcChzcmMpKSB7XG4gICAgLy8gICByZXF1aXJlKCdmbGlwbG9nJykudW5kZXJsaW5lKCdpcyBtYXAnKS5lY2hvKClcbiAgICAvLyAgIGRzdCA9IHJlZHVjZShzcmMuZW50cmllcygpKVxuICAgIC8vIH1cbiAgICAvLyBlbHNlIGlmIChpc1NldChzcmMpKSB7XG4gICAgLy8gICBkc3QgPSB0b2FycihzcmMpXG4gICAgLy8gfVxuICAgIGlmIChpc0FycmF5KHNyYykpIHtcbiAgICAgIGRzdCA9IFtdXG4gICAgfVxuICAgIGVsc2UgaWYgKGlzRGF0ZShzcmMpKSB7XG4gICAgICBkc3QgPSBuZXcgRGF0ZShzcmMuZ2V0VGltZSA/IHNyYy5nZXRUaW1lKCkgOiBzcmMpXG4gICAgfVxuICAgIGVsc2UgaWYgKGlzUmVnRXhwKHNyYykpIHtcbiAgICAgIGRzdCA9IG5ldyBSZWdFeHAoc3JjKVxuICAgIH1cbiAgICBlbHNlIGlmIChpc0Vycm9yKHNyYykpIHtcbiAgICAgIGRzdCA9IHttZXNzYWdlOiBzcmMubWVzc2FnZX1cbiAgICB9XG4gICAgZWxzZSBpZiAoaXNCb29sZWFuKHNyYykpIHtcbiAgICAgIGRzdCA9IG5ldyBCb29sZWFuKHNyYylcbiAgICB9XG4gICAgZWxzZSBpZiAoaXNOdW1iZXIoc3JjKSkge1xuICAgICAgZHN0ID0gbmV3IE51bWJlcihzcmMpXG4gICAgfVxuICAgIGVsc2UgaWYgKGlzU3RyaW5nKHNyYykpIHtcbiAgICAgIGRzdCA9IG5ldyBTdHJpbmcoc3JjKVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIC8vaWYgKE9iamVjdC5jcmVhdGUgJiYgT2JqZWN0LmdldFByb3RvdHlwZU9mKVxuICAgICAgZHN0ID0gT2JqZWN0LmNyZWF0ZShPYmplY3QuZ2V0UHJvdG90eXBlT2Yoc3JjKSlcbiAgICB9XG4gICAgLy8gZWxzZSBpZiAoc3JjLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHtcbiAgICAvLyAgIGRzdCA9IHt9XG4gICAgLy8gfVxuICAgIC8vIGVsc2Uge1xuICAgIC8vICAgLy8gQE5PVEU6IG9ubHkgaGFwcGVucyBpZiBhYm92ZSBnZXRQcm90b3R5cGVPZiBkb2VzIG5vdCBleGlzdFxuICAgIC8vICAgdmFyIHByb3RvID0gKHNyYy5jb25zdHJ1Y3RvciAmJiBzcmMuY29uc3RydWN0b3IucHJvdG90eXBlKSB8fFxuICAgIC8vICAgc3JjLl9fcHJvdG9fXyB8fCB7fVxuICAgIC8vICAgdmFyIFQgPSBmdW5jdGlvbigpIHt9XG4gICAgLy8gICBULnByb3RvdHlwZSA9IHByb3RvXG4gICAgLy8gICBkc3QgPSBuZXcgVCgpXG4gICAgLy8gfVxuXG4gICAgZm9yRWFjaChvYmplY3RLZXlzKHNyYyksIGtleSA9PiB7XG4gICAgICBkc3Rba2V5XSA9IHNyY1trZXldXG4gICAgfSlcbiAgICByZXR1cm4gZHN0XG4gIH1cbiAgZWxzZSB7XG4gICAgLy8gcmVxdWlyZSgnZmxpcGxvZycpLnJlZCgnaXMgTk9UIE9CSicpLmVjaG8oKVxuICAgIHJldHVybiBzcmNcbiAgfVxufVxuXG5mb3JFYWNoKG9iamVjdEtleXMoVHJhdmVyc2UucHJvdG90eXBlKSwga2V5ID0+IHtcbiAgdHJhdmVyc2Vba2V5XSA9IGZ1bmN0aW9uKG9iaikge1xuICAgIC8vIHZhciBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpXG4gICAgbGV0IGFyZ3MgPSBhcmd1bWVudG9yLmFwcGx5KG51bGwsIGFyZ3VtZW50cykuc2xpY2UoMSlcblxuICAgIGNvbnN0IHQgPSBuZXcgVHJhdmVyc2Uob2JqKVxuICAgIHJldHVybiB0W2tleV0uYXBwbHkodCwgYXJncylcbiAgfVxufSlcbiJdLCJuYW1lcyI6WyJjb25zdCIsImxldCJdLCJtYXBwaW5ncyI6IkFBQUE7OztBQUdBQSxHQUFLLENBQUMsU0FBUyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUM7QUFDekNBLEdBQUssQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQztBQUN2Q0EsR0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDO0FBQ3JDQSxHQUFLLENBQUMsU0FBUyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUM7QUFDekNBLEdBQUssQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQztBQUN2Q0EsR0FBSyxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDO0FBQ3ZDQSxHQUFLLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUM7O0FBRW5DQSxHQUFLLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUM7QUFDckNBLEdBQUssQ0FBQyxjQUFjLEdBQUcsT0FBTyxDQUFDLHVCQUF1QixDQUFDO0FBQ3ZEQSxHQUFLLENBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUM7QUFD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